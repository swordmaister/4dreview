<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D World Viewer - Pro (Touch Fix)</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠè¨­å®šï¼šã“ã“ãŒé‡è¦ */
        #container { display: flex; height: 100vh; width: 100vw; }
        
        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ãƒŠã« touch-action: none ã‚’è¨­å®šã—ã¦ã€
           ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–ã‚ºãƒ¼ãƒ /ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã€Three.jsã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¸¡ã™ */
        #viewer-pane, #canvas-container, canvas {
            touch-action: none; 
            outline: none;
        }
        
        /* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */
        #editor-pane { width: 350px; background: #1e1e1e; display: flex; flex-direction: column; border-right: 1px solid #444; z-index: 10; transition: transform 0.3s ease; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { padding: 8px; background: #252526; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; border-bottom: 1px solid #333; }
        .toolbar button, .toolbar label { 
            background: #3a3a3a; color: #eee; border: 1px solid #555; padding: 6px 10px; 
            cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }
        .toolbar button:active { transform: translateY(1px); }
        .toolbar input[type="checkbox"] { margin-right: 4px; }
        
        .btn-run { background: #0e639c; color: white; flex-grow: 2; border-color: #0e639c; font-size: 12px; }
        .btn-fs { background: #d67f00; color: white; border-color: #d67f00; flex-grow: 1; }
        .btn-action { background: #444; }
        .btn-clear { background: #6e3535; color: #ffcccc; }

        .file-label { background: #2d2d2d !important; }

        /* ã‚¹ã‚¯ãƒªãƒ—ãƒˆç®¡ç†ã‚¨ãƒªã‚¢ */
        #script-manager { background: #252526; padding: 8px; border-bottom: 1px solid #333; }
        .save-controls { display: flex; gap: 4px; margin-bottom: 8px; }
        #script-title { flex-grow: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; outline: none; }
        #script-list { max-height: 120px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
        
        .script-item { display: flex; align-items: center; background: #2d2d2d; padding: 4px; border-radius: 3px; font-size: 11px; }
        .script-name { flex-grow: 1; padding-left: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; color: #ccc; }
        .script-name:hover { text-decoration: underline; color: #fff; }
        .btn-xs { padding: 2px 6px; margin-left: 4px; font-size: 10px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-load { background: #305035; color: #cfc; }
        .btn-del { background: #503030; color: #fcc; }

        /* ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ */
        #code-editor { flex-grow: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 10px; font-family: monospace; font-size: 13px; outline: none; resize: none; white-space: pre; overflow-x: auto; tab-size: 4; }
        
        #viewer-pane { flex-grow: 1; position: relative; }
        
        body.fullscreen-mode #editor-pane { transform: translateX(-350px); width: 0; min-width: 0; }
        #close-btn { position: absolute; top: 15px; left: 15px; width: 44px; height: 44px; background: rgba(200, 50, 50, 0.8); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; font-size: 24px; cursor: pointer; display: none; z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        body.fullscreen-mode #close-btn { display: flex; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
    
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/webxr/VRButton.js"></script>
</head>
<body>

<div id="container">
    <div id="editor-pane">
        <div class="toolbar">
            <button class="btn-run" onclick="runCode()">â–¶ å®Ÿè¡Œ (Run)</button>
            <button class="btn-fs" onclick="toggleFS()" title="å…¨ç”»é¢è¡¨ç¤º">å…¨ç”»é¢</button>
        </div>
        <div class="toolbar" style="padding-top:0;">
            <label title="ã‚«ãƒ¡ãƒ©æ“ä½œã®æœ‰åŠ¹/ç„¡åŠ¹"><input type="checkbox" id="chk-orbit" checked onchange="toggleOrbit()">Orbit(Cam)</label>
            <label class="file-label" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã">ğŸ“‚<input type="file" onchange="loadFile(this)" style="display:none"></label>
            <button class="btn-action" onclick="copyCode()">Copy</button>
            <button class="btn-action" onclick="pasteCode()">Paste</button>
            <button class="btn-clear" onclick="clearCode()">Clear</button>
        </div>
        
        <div id="script-manager">
            <div class="save-controls">
                <input type="text" id="script-title" placeholder="Script Title...">
                <button class="btn-action" onclick="saveScript()">Save</button>
            </div>
            <div id="script-list"></div>
        </div>
        
        <textarea id="code-editor" spellcheck="false" placeholder="// ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›...">
// --- ã‚µãƒ³ãƒ—ãƒ«: ã‚«ãƒ¡ãƒ©æ“ä½œãƒ†ã‚¹ãƒˆ ---

// 1. Orbit(Cam) ON ã®å ´åˆ:
//    ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã§è‡ªç”±ã«å›è»¢ãƒ»ã‚ºãƒ¼ãƒ ã§ãã¾ã™ã€‚
//    ã‚³ãƒ¼ãƒ‰å†…ã® camera.position è¨­å®šã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

// 2. Orbit(Cam) OFF ã®å ´åˆ:
//    ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

const geo = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
const mat = new THREE.MeshNormalMaterial();
const mesh = new THREE.Mesh(geo, mat);
scene.add(mesh);
scene.add(new THREE.GridHelper(20, 20));

// åˆæœŸä½ç½®
camera.position.set(0, 2, 5);

function update(t) {
    mesh.rotation.x = t * 0.0005;
    mesh.rotation.y = t * 0.001;
    
    // OrbitãŒOFFã®æ™‚ã ã‘ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚«ãƒ¡ãƒ©ã‚’å‹•ã‹ã™ä¾‹
    // (ONã®æ™‚ã«ã“ã‚Œã‚’ã‚„ã‚‹ã¨ã‚¬ã‚¿ã‚¬ã‚¿éœ‡ãˆã¾ã™)
    if (!controls.enabled) {
        // camera.position.x = Math.sin(t * 0.0005) * 5;
        // camera.lookAt(0, 0, 0);
    }
}
</textarea>
    </div>

    <div id="viewer-pane">
        <button id="close-btn" onclick="toggleFS()">âœ•</button>
        <div id="canvas-container" style="width:100%; height:100%;"></div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, updateFunc = null;
    const STORAGE_KEY = '3d_viewer_scripts';

    // --- Script Management (å¤‰æ›´ãªã—) ---
    function getSavedScripts() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e) { return []; } }
    function renderScriptList() {
        const list = document.getElementById('script-list');
        list.innerHTML = '';
        const scripts = getSavedScripts();
        if(scripts.length === 0) { list.innerHTML = '<div style="color:#666; font-size:10px; padding:4px;">No saved scripts</div>'; return; }
        scripts.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'script-item';
            div.innerHTML = `<span class="script-name" onclick="loadScript(${index})">${item.title}</span><button class="btn-xs btn-load" onclick="loadScript(${index})">Load</button><button class="btn-xs btn-del" onclick="deleteScript(${index})">âœ•</button>`;
            list.appendChild(div);
        });
    }
    function saveScript() {
        const titleInput = document.getElementById('script-title');
        const code = document.getElementById('code-editor').value;
        const title = titleInput.value.trim() || 'Untitled ' + new Date().toLocaleTimeString();
        const scripts = getSavedScripts();
        scripts.unshift({ title: title, code: code, date: new Date().toISOString() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scripts));
        titleInput.value = ''; renderScriptList();
    }
    function loadScript(index) {
        const scripts = getSavedScripts();
        if(scripts[index]) {
            if(document.getElementById('code-editor').value !== scripts[index].code && !confirm('ä¸Šæ›¸ãã—ã¦ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) return;
            document.getElementById('code-editor').value = scripts[index].code;
            document.getElementById('script-title').value = scripts[index].title;
            runCode();
        }
    }
    function deleteScript(index) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { const s = getSavedScripts(); s.splice(index, 1); localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); renderScriptList(); } }

    // --- UI Logic ---
    function copyCode() { const t = document.getElementById('code-editor'); t.select(); navigator.clipboard.writeText(t.value); }
    async function pasteCode() { try { document.getElementById('code-editor').value = await navigator.clipboard.readText(); } catch(e) { alert('Ctrl+Vã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„'); } }
    function clearCode() { if(confirm('æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) document.getElementById('code-editor').value = ''; }
    
    function toggleFS() { 
        document.body.classList.toggle('fullscreen-mode'); 
        setTimeout(resizeRenderer, 350); 
    }
    
    function resizeRenderer() {
        const container = document.getElementById('viewer-pane');
        const w = container.clientWidth;
        const h = container.clientHeight;
        if(camera && renderer) {
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }
    }

    function loadFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('code-editor').value = e.target.result;
            document.getElementById('script-title').value = file.name;
            runCode();
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    // --- Controls Control ---
    function toggleOrbit() {
        if(!controls) return;
        const isEnabled = document.getElementById('chk-orbit').checked;
        controls.enabled = isEnabled;
        // enabledåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ä½™è¨ˆãªæ…£æ€§ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«æ›´æ–°ã‚’ä¸€å›æ­¢ã‚ã‚‹ãªã©ã®å‡¦ç½®ã¯
        // OrbitControlså†…éƒ¨ã§enabledãƒ•ãƒ©ã‚°ã«ã‚ˆã‚Šå‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ã“ã‚Œã ã‘ã§OK
    }

    // --- Three.js Init ---
    function init() {
        if (typeof THREE === 'undefined') { setTimeout(init, 100); return; }
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        
        const container = document.getElementById('canvas-container');
        container.appendChild(renderer.domElement);
        
        if (typeof VRButton !== 'undefined') {
            document.body.appendChild(VRButton.createButton(renderer));
        }

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // æ…£æ€§ã‚’æœ‰åŠ¹åŒ–
        controls.dampingFactor = 0.05;
        controls.target.set(0, 1.6, 0);

        // ãƒ«ãƒ¼ãƒ—
        renderer.setAnimationLoop((time) => {
            if (updateFunc) {
                try { updateFunc(time); } catch(e) { console.error(e); updateFunc = null; }
            }
            
            // OrbitãŒæœ‰åŠ¹ãªæ™‚ã ã‘controls.update()ã‚’å‘¼ã¶
            if (controls && controls.enabled) {
                controls.update();
            }
            
            renderer.render(scene, camera);
        });

        window.addEventListener('resize', resizeRenderer);
        renderScriptList();
        runCode();
    }

    // --- Run Code (Fixes applied here) ---
    function runCode() {
        const code = document.getElementById('code-editor').value;
        
        while(scene.children.length > 0){ scene.remove(scene.children[0]); }
        
        // â˜… å®Ÿè¡Œæ™‚ã«Controlsã®è¨­å®šã‚’å¥å…¨ãªçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
        if(controls) {
            controls.reset();
            controls.minDistance = 0; // è·é›¢åˆ¶é™è§£é™¤
            controls.maxDistance = Infinity; // è·é›¢åˆ¶é™è§£é™¤
            controls.minPolarAngle = 0; // è§’åº¦åˆ¶é™è§£é™¤
            controls.maxPolarAngle = Math.PI; // è§’åº¦åˆ¶é™è§£é™¤
            controls.enableZoom = true; // ã‚ºãƒ¼ãƒ æœ‰åŠ¹åŒ–
            controls.enableRotate = true; // å›è»¢æœ‰åŠ¹åŒ–
            controls.enablePan = true; // ãƒ‘ãƒ³æœ‰åŠ¹åŒ–
            
            // UIã®çŠ¶æ…‹ã¨åŒæœŸ
            controls.enabled = document.getElementById('chk-orbit').checked;
            
            // ã‚«ãƒ¡ãƒ©ä½ç½®ãƒªã‚»ãƒƒãƒˆ
            camera.position.set(0, 1.6, 5);
            camera.rotation.set(0, 0, 0);
            controls.target.set(0, 1.6, 0);
            controls.update();
        }

        updateFunc = null;

        try {
            const f = new Function('scene', 'camera', 'renderer', 'controls', 'THREE', code + '\n return typeof update!=="undefined"?update:null;');
            // controls ã‚‚å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã‹ã‚‰ controls.autoRotate = true ãªã©ã‚‚å¯èƒ½ã«ã™ã‚‹
            updateFunc = f(scene, camera, renderer, controls, THREE);
        } catch (e) { 
            console.error(e); 
        }
    }

    window.onload = init;
</script>
</body>
</html>
